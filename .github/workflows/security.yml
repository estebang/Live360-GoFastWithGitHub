name: Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run security scans every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    permissions:
      security-events: write
      contents: read
      actions: read
    
    strategy:
      fail-fast: false
      matrix:
        language: ['csharp']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-and-quality
          config: |
            paths-ignore:
              - '**/obj/**'
              - '**/bin/**'
              - '**/*.Designer.cs'
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore dependencies
        run: dotnet restore ./TailspinToys.sln
      
      - name: Build solution for CodeQL
        run: |
          dotnet build ./TailspinToys.sln \
            --configuration Release \
            --no-restore
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
      
      - name: Upload CodeQL results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ../results/${{ matrix.language }}.sarif
        continue-on-error: true

  dependency-scan:
    name: Dependency Scanning
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      - name: Restore dependencies
        run: dotnet restore ./TailspinToys.sln
      
      - name: Install dotnet-outdated tool
        run: dotnet tool install --global dotnet-outdated-tool
      
      - name: Check for outdated packages
        run: |
          dotnet outdated ./TailspinToys.sln --output outdated-packages.json || true
      
      - name: List NuGet packages
        run: |
          echo "## NuGet Packages Report üì¶" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          dotnet list ./TailspinToys.sln package >> $GITHUB_STEP_SUMMARY || true
      
      - name: Upload package list
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: outdated-packages.json
          retention-days: 30
        continue-on-error: true

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true
      
      - name: Secret scan summary
        run: |
          echo "## Secret Scanning Complete üîê" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Secret scanning has been completed. Review the results above." >> $GITHUB_STEP_SUMMARY

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, secret-scan]
    if: always()
    
    permissions:
      contents: read
    
    steps:
      - name: Generate security summary
        run: |
          echo "## üõ°Ô∏è Security Scanning Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual scan results for detailed findings." >> $GITHUB_STEP_SUMMARY
      
      - name: Check for failures
        if: needs.codeql-analysis.result == 'failure' || needs.dependency-scan.result == 'failure' || needs.secret-scan.result == 'failure'
        run: |
          echo "‚ö†Ô∏è One or more security scans failed. Please review the results."
          exit 1
