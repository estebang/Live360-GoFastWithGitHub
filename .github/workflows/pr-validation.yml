# ðŸ” Pull Request Validation Workflow
#
# Comprehensive validation for pull requests to ensure code quality,
# security, and compatibility before merging. This workflow runs
# extensive checks without deploying to live environments.
#
# Features:
# - Multi-OS testing matrix
# - Code quality analysis  
# - Security scanning
# - Performance testing
# - Documentation validation

name: 'ðŸ” PR Validation'

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop, release/**]
  
  pull_request_review:
    types: [submitted]

# Security: Read-only permissions for PR validation
permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write

env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  # ðŸ“‹ PR metadata and validation
  pr-validation:
    name: 'ðŸ“‹ PR Validation'
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    outputs:
      should-run-tests: ${{ steps.changes.outputs.should-run-tests }}
      has-code-changes: ${{ steps.changes.outputs.has-code-changes }}
      has-docs-changes: ${{ steps.changes.outputs.has-docs-changes }}
    
    steps:
      - name: 'ðŸ“¥ Checkout PR'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection
      
      - name: 'ðŸ” Analyze PR changes'
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'src/**/*.cs'
              - 'tests/**/*.cs'
              - '**/*.csproj'
              - '**/*.props'
              - '**/*.targets'
            
            docs:
              - '**.md'
              - 'docs/**'
            
            workflows:
              - '.github/workflows/**'
              - '.github/actions/**'
            
            config:
              - 'appsettings*.json'
              - 'web.config'
              - '*.config'
      
      - name: 'ðŸ“Š PR Summary'
        run: |
          echo "## ðŸ” PR Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Change Type | Detected |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Changes | ${{ steps.changes.outputs.code == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ steps.changes.outputs.docs == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY  
          echo "| Workflows | ${{ steps.changes.outputs.workflows == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ steps.changes.outputs.config == 'true' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Set outputs for downstream jobs
          if [[ "${{ steps.changes.outputs.code }}" == "true" ]]; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "has-code-changes=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "has-code-changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "has-docs-changes=${{ steps.changes.outputs.docs }}" >> $GITHUB_OUTPUT

  # ðŸ—ï¸ Multi-platform build validation
  build-matrix:
    name: 'ðŸ—ï¸ Build (${{ matrix.os }}, .NET ${{ matrix.dotnet-version }})'
    runs-on: ${{ matrix.os }}
    needs: pr-validation
    if: needs.pr-validation.outputs.has-code-changes == 'true'
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet-version: ['9.0.x']
        include:
          - os: ubuntu-latest
            artifact-name: 'linux-build'
          - os: windows-latest  
            artifact-name: 'windows-build'
          - os: macos-latest
            artifact-name: 'macos-build'
    
    steps:
      - name: 'ðŸ“¥ Checkout code'
        uses: actions/checkout@v4
      
      - name: 'ðŸ—ï¸ Build and test'
        uses: ./.github/actions/build-dotnet
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
          configuration: ${{ env.BUILD_CONFIGURATION }}
          run-tests: true
          collect-coverage: ${{ matrix.os == 'ubuntu-latest' }}  # Collect coverage only on Linux
          publish-app: ${{ matrix.os == 'ubuntu-latest' }}       # Publish only on Linux
          publish-path: './publish'

  # ðŸ§ª Extended testing
  extended-tests:
    name: 'ðŸ§ª Extended Testing'
    runs-on: ubuntu-latest
    needs: [pr-validation, build-matrix]
    if: needs.pr-validation.outputs.has-code-changes == 'true'
    
    strategy:
      matrix:
        test-type: [unit, integration, performance]
    
    steps:
      - name: 'ðŸ“¥ Checkout code'
        uses: actions/checkout@v4
      
      - name: 'ðŸ—ï¸ Setup .NET'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: 'ðŸ§ª Run ${{ matrix.test-type }} tests'
        run: |
          echo "::group::${{ matrix.test-type }} Tests"
          
          case "${{ matrix.test-type }}" in
            "unit")
              echo "ðŸ§ª Running unit tests with coverage"
              dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} \
                --collect:"XPlat Code Coverage" \
                --filter "Category!=Integration&Category!=Performance" \
                --verbosity normal
              ;;
            "integration")  
              echo "ðŸ”— Running integration tests"
              dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} \
                --filter "Category=Integration" \
                --verbosity normal
              ;;
            "performance")
              echo "ðŸš€ Running performance tests"
              dotnet test --configuration ${{ env.BUILD_CONFIGURATION }} \
                --filter "Category=Performance" \
                --verbosity normal
              ;;
          esac
          
          echo "::endgroup::"

  # ðŸ”’ Security analysis
  security-analysis:
    name: 'ðŸ”’ Security Analysis'  
    runs-on: ubuntu-latest
    needs: pr-validation
    if: needs.pr-validation.outputs.has-code-changes == 'true'
    
    steps:
      - name: 'ðŸ“¥ Checkout code'
        uses: actions/checkout@v4
      
      - name: 'ðŸ” CodeQL Analysis'
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          queries: security-and-quality,security-extended
      
      - name: 'ðŸ—ï¸ Build for CodeQL'
        uses: github/codeql-action/autobuild@v3
      
      - name: 'ðŸ“Š Perform CodeQL Analysis'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"
      
      - name: 'ðŸ”’ Dependency vulnerability scan'
        run: |
          echo "::group::Dependency Security Scan"
          
          # Check for vulnerable packages
          echo "ðŸ” Scanning for vulnerable dependencies..."
          VULNERABLE_OUTPUT=$(dotnet list package --vulnerable --include-transitive 2>&1)
          
          if echo "$VULNERABLE_OUTPUT" | grep -q "has the following vulnerable packages"; then
            echo "âš ï¸ Vulnerable dependencies found:"
            echo "$VULNERABLE_OUTPUT"
            echo "::warning::Vulnerable dependencies detected. Please review and update packages."
          else
            echo "âœ… No vulnerable dependencies detected"
          fi
          
          echo "::endgroup::"

  # ðŸ“ Documentation validation
  docs-validation:
    name: 'ðŸ“ Documentation Validation'
    runs-on: ubuntu-latest
    needs: pr-validation
    if: needs.pr-validation.outputs.has-docs-changes == 'true'
    
    steps:
      - name: 'ðŸ“¥ Checkout code'
        uses: actions/checkout@v4
      
      - name: 'ðŸ“ Validate markdown files'
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'
          config: |
            {
              "default": true,
              "MD013": false,
              "MD033": false,
              "MD041": false
            }
      
      - name: 'ðŸ”— Check for broken links'
        run: |
          echo "::group::Link Validation"
          echo "ðŸ”— Checking for broken links in documentation..."
          
          # Simple link checking (can be enhanced with specialized tools)
          find . -name "*.md" -exec grep -l "http" {} \; | while read file; do
            echo "ðŸ“„ Checking links in: $file"
            # Extract URLs and check basic format
            grep -o 'https\?://[^)]*' "$file" | head -5 | while read url; do
              echo "  ðŸ”— Found: $url"
            done
          done
          
          echo "::endgroup::"

  # ðŸ“Š PR Status Check
  pr-status:
    name: 'ðŸ“Š PR Status Summary'
    runs-on: ubuntu-latest
    needs: [pr-validation, build-matrix, extended-tests, security-analysis, docs-validation]
    if: always()
    
    steps:
      - name: 'ðŸ“Š Generate PR summary'
        run: |
          echo "## ðŸŽ¯ PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build status
          BUILD_STATUS="${{ needs.build-matrix.result }}"
          if [[ "$BUILD_STATUS" == "success" ]]; then
            echo "âœ… **Build:** All platforms passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "$BUILD_STATUS" == "failure" ]]; then  
            echo "âŒ **Build:** Failed on one or more platforms" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Build:** Skipped (no code changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Test status
          TEST_STATUS="${{ needs.extended-tests.result }}"
          if [[ "$TEST_STATUS" == "success" ]]; then
            echo "âœ… **Tests:** All test suites passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "$TEST_STATUS" == "failure" ]]; then
            echo "âŒ **Tests:** Some tests failed" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Tests:** Skipped (no code changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security status  
          SECURITY_STATUS="${{ needs.security-analysis.result }}"
          if [[ "$SECURITY_STATUS" == "success" ]]; then
            echo "ðŸ”’ **Security:** No issues detected" >> $GITHUB_STEP_SUMMARY
          elif [[ "$SECURITY_STATUS" == "failure" ]]; then
            echo "ðŸš¨ **Security:** Issues detected - review required" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Security:** Skipped (no code changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Overall status
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "$BUILD_STATUS" == "success" && "$TEST_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
            echo "ðŸŽ‰ **Overall Status:** Ready for review and merge!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall Status:** Issues detected - please review and fix" >> $GITHUB_STEP_SUMMARY
          fi