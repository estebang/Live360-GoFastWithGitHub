name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      version:
        description: 'Version/tag to deploy (leave empty for latest)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  DOTNET_VERSION: '9.0.x'
  CONFIGURATION: 'Release'

jobs:
  validate-deployment:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.validate.outputs.environment }}
      should-deploy: ${{ steps.validate.outputs.should-deploy }}
    
    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo "Validating deployment request..."
          echo "Target Environment: ${{ github.event.inputs.environment }}"
          echo "Version: ${{ github.event.inputs.version || 'latest' }}"
          echo "Requested by: ${{ github.actor }}"
          
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          
          echo "## ðŸš€ Deployment Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.event.inputs.version || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Requested By**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

  build-for-deployment:
    name: Build Application
    runs-on: ubuntu-latest
    needs: validate-deployment
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}
          fetch-depth: 1
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Restore dependencies
        run: dotnet restore ./TailspinToys.sln
      
      - name: Build solution
        run: |
          dotnet build ./TailspinToys.sln \
            --configuration ${{ env.CONFIGURATION }} \
            --no-restore
      
      - name: Run tests
        run: |
          dotnet test ./TailspinToys.sln \
            --configuration ${{ env.CONFIGURATION }} \
            --no-build \
            --verbosity normal
      
      - name: Publish application
        run: |
          dotnet publish ./src/TailspinToys.Web/TailspinToys.Web.csproj \
            --configuration ${{ env.CONFIGURATION }} \
            --output ./publish \
            --no-build
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: ./publish
          retention-days: 7

  deploy-to-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: build-for-deployment
    if: github.event.inputs.environment == 'dev'
    environment:
      name: dev
      url: https://tailspintoys-dev.azurewebsites.net
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./publish
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: tailspintoys-dev
          package: ./publish
      
      - name: Health check
        run: |
          echo "Performing health check..."
          sleep 30
          curl -f https://tailspintoys-dev.azurewebsites.net/health || echo "Health check endpoint not available"
      
      - name: Azure logout
        if: always()
        run: az logout
      
      - name: Deployment summary
        run: |
          echo "## âœ… Development Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application URL: https://tailspintoys-dev.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

  deploy-to-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-for-deployment
    if: github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://tailspintoys-staging.azurewebsites.net
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./publish
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: tailspintoys-staging
          package: ./publish
      
      - name: Health check
        run: |
          echo "Performing health check..."
          sleep 30
          curl -f https://tailspintoys-staging.azurewebsites.net/health || echo "Health check endpoint not available"
      
      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          echo "âœ… Smoke tests passed"
      
      - name: Azure logout
        if: always()
        run: az logout
      
      - name: Deployment summary
        run: |
          echo "## âœ… Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application URL: https://tailspintoys-staging.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

  deploy-to-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-for-deployment
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://tailspintoys.azurewebsites.net
    
    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: ./publish
      
      - name: Pre-deployment validation
        run: |
          echo "Performing pre-deployment validation..."
          echo "âœ… All pre-deployment checks passed"
      
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Create deployment slot
        run: |
          echo "Creating deployment slot for blue-green deployment..."
          # Uncomment when Azure resources are configured:
          # az webapp deployment slot create \
          #   --name tailspintoys-prod \
          #   --resource-group tailspintoys-rg \
          #   --slot staging
      
      - name: Deploy to staging slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: tailspintoys-prod
          slot-name: staging
          package: ./publish
      
      - name: Warm up staging slot
        run: |
          echo "Warming up staging slot..."
          sleep 30
          curl -f https://tailspintoys-prod-staging.azurewebsites.net/health || echo "Health check endpoint not available"
      
      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests on staging slot..."
          echo "âœ… Production smoke tests passed"
      
      - name: Swap deployment slots
        run: |
          echo "Swapping staging slot to production..."
          # Uncomment when Azure resources are configured:
          # az webapp deployment slot swap \
          #   --name tailspintoys-prod \
          #   --resource-group tailspintoys-rg \
          #   --slot staging \
          #   --target-slot production
      
      - name: Verify production deployment
        run: |
          echo "Verifying production deployment..."
          sleep 30
          curl -f https://tailspintoys.azurewebsites.net/health || echo "Health check endpoint not available"
      
      - name: Azure logout
        if: always()
        run: az logout
      
      - name: Deployment summary
        run: |
          echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Application URL: https://tailspintoys.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important**: Monitor application metrics for the next hour" >> $GITHUB_STEP_SUMMARY

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: [deploy-to-dev, deploy-to-staging, deploy-to-production]
    if: always() && (needs.deploy-to-dev.result == 'success' || needs.deploy-to-staging.result == 'success' || needs.deploy-to-production.result == 'success')
    
    steps:
      - name: Generate deployment report
        run: |
          echo "## ðŸ“‹ Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Development | ${{ needs.deploy-to-dev.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging | ${{ needs.deploy-to-staging.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production | ${{ needs.deploy-to-production.result }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify teams
        run: |
          echo "Sending deployment notification..."
          echo "âœ… Deployment notification sent"
