# Main CI/CD Pipeline for TailspinToys
# This workflow orchestrates the build, test, and deployment processes
# using reusable workflows for consistency and maintainability

name: CI/CD Pipeline

on:
  # Trigger on pushes to main branches and pull requests
  push:
    branches: [ main, develop, demo/* ]
  pull_request:
    branches: [ main, develop ]
  
  # Allow manual workflow runs with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production
      
      skip-tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean

# Global environment variables
env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: 'TailspinToys.sln'
  PROJECT_PATH: 'src/TailspinToys.Web/TailspinToys.Web.csproj'

# Ensure only one workflow runs at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Build and Test
  # Uses the reusable workflow for consistent build and test processes
  build-and-test:
    name: ðŸ”¨ Build & Test
    uses: ./.github/workflows/reusable-build-and-test.yml
    with:
      dotnet-version: '9.0.x'
      configuration: 'Release'
      solution-path: 'TailspinToys.sln'
      upload-coverage: true
      run-security-scan: true
      runs-on: 'ubuntu-latest'
    secrets: inherit
    
    # Skip this job if manual run with skip-tests enabled
    if: ${{ !inputs.skip-tests }}

  # Job 2: Code Quality Analysis
  # Additional quality gates for code maintainability
  code-quality:
    name: ðŸ” Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # Run SonarCloud analysis for code quality metrics
    - name: SonarCloud analysis
      uses: SonarSource/sonarcloud-github-action@master
      if: env.SONAR_TOKEN != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=tailspintoys
          -Dsonar.organization=tailspintoys
          -Dsonar.sources=src/
          -Dsonar.tests=tests/
          -Dsonar.cs.opencover.reportsPaths=**/coverage.opencover.xml
    
    # Check for common security issues in dependencies
    - name: Run dependency check
      run: |
        dotnet list package --vulnerable --include-transitive || echo "No vulnerabilities found"
    
    # Validate project structure and conventions
    - name: Project structure validation
      run: |
        echo "::group::Validating project structure"
        # Check for required files
        required_files=("README.md" "TailspinToys.sln" ".gitignore")
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "::error::Required file $file is missing"
            exit 1
          else
            echo "âœ… Found $file"
          fi
        done
        
        # Check project naming conventions
        if ! find src/ -name "*.csproj" | grep -q "TailspinToys"; then
          echo "::error::Project files should follow TailspinToys naming convention"
          exit 1
        fi
        
        echo "::notice::Project structure validation passed"
        echo "::endgroup::"

  # Job 3: Deploy to Development
  # Automatic deployment to dev environment on develop branch
  deploy-development:
    name: ðŸš€ Deploy to Development
    needs: [build-and-test]
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'development')
    
    # Required permissions for Azure OIDC authentication
    permissions:
      id-token: write
      contents: read
      actions: read
    
    uses: ./.github/workflows/reusable-azure-deploy.yml
    with:
      environment-name: 'development'
      app-name: ${{ vars.AZURE_WEBAPP_NAME_DEV }}
      dotnet-version: '9.0.x'
      configuration: 'Release'
      project-path: 'src/TailspinToys.Web/TailspinToys.Web.csproj'
      solution-path: 'TailspinToys.sln'
      run-health-check: true
      health-check-endpoint: '/health'
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      APP_SETTINGS_JSON: ${{ secrets.DEV_APP_SETTINGS_JSON }}

  # Job 4: Deploy to Staging
  # Deployment to staging environment for pre-production testing
  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    needs: [build-and-test]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
    
    # Required permissions for Azure OIDC authentication
    permissions:
      id-token: write
      contents: read
      actions: read
    
    uses: ./.github/workflows/reusable-azure-deploy.yml
    with:
      environment-name: 'staging'
      app-name: ${{ vars.AZURE_WEBAPP_NAME_STAGING }}
      dotnet-version: '9.0.x'
      configuration: 'Release'
      project-path: 'src/TailspinToys.Web/TailspinToys.Web.csproj'
      solution-path: 'TailspinToys.sln'
      run-health-check: true
      health-check-endpoint: '/health'
      slot-name: 'staging'  # Use deployment slots for zero-downtime
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      APP_SETTINGS_JSON: ${{ secrets.STAGING_APP_SETTINGS_JSON }}

  # Job 5: Integration Tests (Staging)
  # Run integration tests against the staging environment
  integration-tests:
    name: ðŸ§ª Integration Tests
    needs: [deploy-staging]
    runs-on: ubuntu-latest
    if: needs.deploy-staging.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # Run integration tests against staging environment
    - name: Run integration tests
      env:
        TEST_BASE_URL: https://${{ vars.AZURE_WEBAPP_NAME_STAGING }}-staging.azurewebsites.net
      run: |
        echo "::group::Running integration tests"
        # Add integration test commands here when available
        echo "Integration test base URL: $TEST_BASE_URL"
        
        # Example: Run API tests
        # dotnet test tests/TailspinToys.IntegrationTests/ --configuration Release --logger "console;verbosity=detailed"
        
        # For now, just verify the application is responding
        curl -f "$TEST_BASE_URL" || exit 1
        echo "::notice::Integration tests passed"
        echo "::endgroup::"

  # Job 6: Deploy to Production
  # Manual approval required for production deployment
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    needs: [build-and-test, integration-tests]
    if: |
      (needs.integration-tests.result == 'success' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    
    # Required permissions for Azure OIDC authentication
    permissions:
      id-token: write
      contents: read
      actions: read
    
    uses: ./.github/workflows/reusable-azure-deploy.yml
    with:
      environment-name: 'production'
      app-name: ${{ vars.AZURE_WEBAPP_NAME_PROD }}
      dotnet-version: '9.0.x'
      configuration: 'Release'
      project-path: 'src/TailspinToys.Web/TailspinToys.Web.csproj'
      solution-path: 'TailspinToys.sln'
      run-health-check: true
      health-check-endpoint: '/health'
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      APP_SETTINGS_JSON: ${{ secrets.PROD_APP_SETTINGS_JSON }}

  # Job 7: Production Smoke Tests
  # Verify production deployment is working correctly
  production-smoke-tests:
    name: ðŸ’¨ Production Smoke Tests
    needs: [deploy-production]
    runs-on: ubuntu-latest
    if: needs.deploy-production.result == 'success'
    
    steps:
    - name: Production health check
      run: |
        echo "::group::Running production smoke tests"
        PROD_URL="https://${{ vars.AZURE_WEBAPP_NAME_PROD }}.azurewebsites.net"
        
        # Basic health check
        if curl -f -s "$PROD_URL" > /dev/null; then
          echo "âœ… Production site is responding"
        else
          echo "âŒ Production site is not responding"
          exit 1
        fi
        
        # Check response time
        RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$PROD_URL")
        echo "Response time: ${RESPONSE_TIME}s"
        
        # Alert if response time is too slow (> 5 seconds)
        if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
          echo "::warning::Production response time is slow: ${RESPONSE_TIME}s"
        fi
        
        echo "::notice title=Production Deployed::Successfully deployed to production: $PROD_URL"
        echo "::endgroup::"

  # Job 8: Notification
  # Send deployment notifications to team channels
  notify:
    name: ðŸ“¢ Notify Team
    needs: [deploy-production, production-smoke-tests]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-production.result == 'failure')
    
    steps:
    - name: Send Teams notification
      if: env.TEAMS_WEBHOOK_URL != ''
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
      run: |
        STATUS="${{ needs.deploy-production.result }}"
        COLOR="28a745"  # Green for success
        if [ "$STATUS" != "success" ]; then
          COLOR="dc3545"  # Red for failure
        fi
        
        curl -H "Content-Type: application/json" -d "{
          \"@type\": \"MessageCard\",
          \"@context\": \"https://schema.org/extensions\",
          \"themeColor\": \"$COLOR\",
          \"summary\": \"TailspinToys Deployment $STATUS\",
          \"sections\": [{
            \"activityTitle\": \"TailspinToys Production Deployment\",
            \"activitySubtitle\": \"Status: $STATUS\",
            \"facts\": [{
              \"name\": \"Environment\",
              \"value\": \"Production\"
            }, {
              \"name\": \"Commit\",
              \"value\": \"${{ github.sha }}\"
            }, {
              \"name\": \"Branch\",
              \"value\": \"${{ github.ref_name }}\"
            }],
            \"potentialAction\": [{
              \"@type\": \"OpenUri\",
              \"name\": \"View Deployment\",
              \"targets\": [{
                \"os\": \"default\",
                \"uri\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }]
            }]
          }]
        }" "$TEAMS_WEBHOOK_URL" || echo "Failed to send Teams notification"
    
    - name: Send Slack notification
      if: env.SLACK_WEBHOOK_URL != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        STATUS="${{ needs.deploy-production.result }}"
        EMOJI=":white_check_mark:"
        if [ "$STATUS" != "success" ]; then
          EMOJI=":x:"
        fi
        
        curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \"$EMOJI TailspinToys Production Deployment $STATUS\",
            \"attachments\": [{
              \"color\": \"$( [ '$STATUS' = 'success' ] && echo 'good' || echo 'danger' )\",
              \"fields\": [{
                \"title\": \"Environment\",
                \"value\": \"Production\",
                \"short\": true
              }, {
                \"title\": \"Commit\",
                \"value\": \"${{ github.sha }}\",
                \"short\": true
              }, {
                \"title\": \"Branch\",
                \"value\": \"${{ github.ref_name }}\",
                \"short\": true
              }],
              \"actions\": [{
                \"type\": \"button\",
                \"text\": \"View Deployment\",
                \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
              }]
            }]
          }" "$SLACK_WEBHOOK_URL" || echo "Failed to send Slack notification"