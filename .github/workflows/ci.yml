name: CI/CD

on:
  push:
    branches: [ main, develop, demo/* ]
  pull_request:
    branches: [ main, develop, demo/* ]
  workflow_dispatch:
    inputs:
      skip-tests:
        description: 'Skip tests'
        required: false
        type: boolean
        default: false
      force-deploy:
        description: 'Force deployment even on PR'
        required: false
        type: boolean
        default: false

env:
  DOTNET_VERSION: '9.0.x'

# Optimize concurrency to cancel in-progress runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

jobs:
  # Security scanning for all branches
  security:
    name: Security Scan
    uses: ./.github/workflows/security-scan.yml
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write
    secrets: inherit
    with:
      dotnet-version: '9.0.x'

  # Build and test
  build:
    name: Build & Test
    needs: [security]
    uses: ./.github/workflows/build-dotnet.yml
    permissions:
      contents: read
      checks: write
    secrets: inherit
    with:
      dotnet-version: '9.0.x'
      configuration: 'Release'
      run-tests: ${{ github.event.inputs.skip-tests != 'true' }}
      upload-artifacts: ${{ github.event_name == 'push' || github.event.inputs.force-deploy == 'true' }}

  # Deploy to development environment
  deploy-dev:
    name: Deploy to Development
    needs: [build]
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event.inputs.force-deploy == 'true' && github.ref == 'refs/heads/develop')
    uses: ./.github/workflows/deploy-azure.yml
    permissions:
      id-token: write
      contents: read
      deployments: write
    secrets:
      azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    with:
      environment: development
      app-name: ${{ vars.AZURE_WEBAPP_NAME_DEV }}
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      dotnet-version: '9.0.x'
      run-smoke-tests: true

  # Deploy to production environment
  deploy-prod:
    name: Deploy to Production
    needs: [build]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event.inputs.force-deploy == 'true' && github.ref == 'refs/heads/main')
    uses: ./.github/workflows/deploy-azure.yml
    permissions:
      id-token: write
      contents: read
      deployments: write
    secrets:
      azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
      azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    with:
      environment: production
      app-name: ${{ vars.AZURE_WEBAPP_NAME_PROD }}
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      dotnet-version: '9.0.x'
      run-smoke-tests: true

  # Notification on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build, deploy-dev, deploy-prod]
    if: failure() && github.event_name == 'push'
    permissions:
      contents: read
    
    steps:
    - name: Create failure summary
      run: |
        echo "## âŒ Workflow Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Run URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please review the failed jobs and address any issues." >> $GITHUB_STEP_SUMMARY