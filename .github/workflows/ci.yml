# ðŸš€ TailspinToys CI/CD Pipeline
# 
# This workflow provides comprehensive CI/CD for the TailspinToys .NET 9 application:
# - ðŸ—ï¸  Build and test with .NET 9
# - ðŸ”’ Security scanning (CodeQL, vulnerability assessment)
# - ðŸš€ Multi-environment deployment (dev â†’ prod)
# - ðŸŒ Azure deployment using OIDC authentication
# - â™»ï¸  Reusable composite actions for maintainability
#
# Triggered on:
# - Push to main/develop branches (full CI/CD)
# - Pull requests (CI only)
# - Manual workflow dispatch with options

name: 'CI/CD Pipeline'

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
  
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
  
  workflow_dispatch:
    inputs:
      deploy_to_dev:
        description: 'Deploy to Development environment'
        required: false
        default: true
        type: boolean
      
      deploy_to_prod:
        description: 'Deploy to Production environment'
        required: false
        default: false
        type: boolean
      
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean

# Security: Minimal permissions with explicit grants
permissions:
  contents: read           # Read repository contents
  id-token: write         # Request OIDC tokens for Azure authentication
  security-events: write  # Upload CodeQL results
  actions: read           # Read workflow run information
  pull-requests: write    # Comment on PRs with results

# ðŸ“Š Global environment variables used across all jobs
env:
  DOTNET_VERSION: '9.0.x'
  BUILD_CONFIGURATION: 'Release'
  ARTIFACT_NAME: 'tailspintoys-app'

jobs:
  # ðŸ—ï¸ BUILD & TEST JOB
  # Builds the application, runs tests, and creates deployment artifacts
  build-and-test:
    name: 'ðŸ—ï¸ Build & Test (.NET 9)'
    runs-on: ubuntu-latest
    
    # ðŸ”„ Strategy matrix allows testing multiple configurations in parallel
    strategy:
      fail-fast: false  # Continue other matrix jobs even if one fails
      matrix:
        os: [ubuntu-latest]
        dotnet-version: ['9.0.x']
    
    # ðŸ“¤ Expose outputs for dependent jobs
    outputs:
      version: ${{ steps.version.outputs.version }}
      test-outcome: ${{ steps.build.outputs.test-outcome }}
    
    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper versioning
      
      # ðŸ·ï¸ Generate semantic version for this build
      - name: 'ðŸ·ï¸ Generate version'
        id: version
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            VERSION="pr-${{ github.event.number }}-${GITHUB_SHA::8}"
          else
            VERSION="${GITHUB_REF_NAME}-${GITHUB_SHA::8}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Build version: ${VERSION}"
      
      # ðŸ—ï¸ Use our custom composite action for build/test
      - name: 'ðŸ—ï¸ Build and test application'
        id: build
        uses: ./.github/actions/build-dotnet
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
          configuration: ${{ env.BUILD_CONFIGURATION }}
          run-tests: ${{ inputs.skip_tests != true }}
          collect-coverage: true
          publish-app: true
          publish-path: './publish'
      
      # ðŸ“¦ Upload deployment artifact for later use
      - name: 'ðŸ“¦ Upload deployment artifact'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./publish
          retention-days: 30
          compression-level: 6
      
      # ðŸ“Š Publish test summary to PR (if applicable)
      - name: 'ðŸ“Š Publish test results'
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: '.NET Tests'
          path: './TestResults/**/*.trx'
          reporter: 'dotnet-trx'

  # ðŸ›¡ï¸ SECURITY ANALYSIS JOB  
  # Performs comprehensive security scanning using multiple tools
  security-analysis:
    name: 'ðŸ›¡ï¸ Security Analysis'
    runs-on: ubuntu-latest
    needs: build-and-test
    
    # ðŸ”„ Run security checks in parallel for faster feedback
    strategy:
      matrix:
        scan-type: [codeql, dependency-scan]
    
    steps:
      - name: 'ðŸ“¥ Checkout repository'
        uses: actions/checkout@v4
      
      # ðŸ” CodeQL Analysis for semantic code scanning
      - name: 'ðŸ” Initialize CodeQL'
        if: matrix.scan-type == 'codeql'
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          config: |
            name: "TailspinToys CodeQL Config"
            queries:
              - uses: security-and-quality
              - uses: security-extended
      
      # ðŸ—ï¸ Build for CodeQL (lightweight build)
      - name: 'ðŸ—ï¸ CodeQL Autobuild'
        if: matrix.scan-type == 'codeql'
        uses: github/codeql-action/autobuild@v3
      
      # ðŸ“Š Perform CodeQL Analysis
      - name: 'ðŸ“Š Perform CodeQL Analysis'
        if: matrix.scan-type == 'codeql'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:csharp"
      
      # ðŸ”’ Dependency vulnerability scanning
      - name: 'ðŸ”’ Dependency Security Scan'
        if: matrix.scan-type == 'dependency-scan'
        uses: ./.github/actions/build-dotnet
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          configuration: Debug  # Debug for faster restore
          run-tests: false
          collect-coverage: false
          publish-app: false
      
      - name: 'ðŸ” Check for vulnerable packages'
        if: matrix.scan-type == 'dependency-scan'
        run: |
          echo "::group::Vulnerability Assessment"
          
          # Check for known vulnerabilities
          echo "ðŸ” Checking for vulnerable packages..."
          VULNERABLE_PACKAGES=$(dotnet list package --vulnerable --include-transitive 2>&1 || echo "No vulnerabilities found")
          
          if echo "$VULNERABLE_PACKAGES" | grep -q "has the following vulnerable packages"; then
            echo "âš ï¸ SECURITY ALERT: Vulnerable packages detected!"
            echo "$VULNERABLE_PACKAGES"
            echo "::error::Vulnerable dependencies found. Please update packages."
            exit 1
          else
            echo "âœ… No vulnerable packages detected"
          fi
          
          # Check for outdated packages
          echo "ðŸ“Š Checking for outdated packages..."
          dotnet list package --outdated
          
          echo "::endgroup::"

  # âœ… QUALITY GATE JOB
  # Determines if the build meets quality standards for deployment
  quality-gate:
    name: 'âœ… Quality Gate'
    runs-on: ubuntu-latest
    needs: [build-and-test, security-analysis]
    if: always()  # Run even if some jobs fail, but evaluate conditions
    
    outputs:
      deploy-ready: ${{ steps.gate.outputs.deploy-ready }}
      gate-status: ${{ steps.gate.outputs.status }}
    
    steps:
      - name: 'ðŸŽ¯ Evaluate quality metrics'
        id: gate
        run: |
          echo "::group::Quality Gate Evaluation"
          
          BUILD_STATUS="${{ needs.build-and-test.result }}"
          SECURITY_STATUS="${{ needs.security-analysis.result }}"
          
          echo "ðŸ—ï¸  Build Status: $BUILD_STATUS"
          echo "ðŸ›¡ï¸  Security Status: $SECURITY_STATUS"
          
          # Determine if deployment should proceed
          if [[ "$BUILD_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
            echo "âœ… Quality gate PASSED - Ready for deployment"
            echo "deploy-ready=true" >> $GITHUB_OUTPUT
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Quality gate FAILED - Deployment blocked"
            echo "deploy-ready=false" >> $GITHUB_OUTPUT
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          
          echo "::endgroup::"

  # ðŸš€ DEVELOPMENT DEPLOYMENT JOB
  # Deploys to development environment for testing and validation
  deploy-dev:
    name: 'ðŸš€ Deploy to Development'
    runs-on: ubuntu-latest
    needs: [build-and-test, quality-gate]
    
    # ðŸŒ Environment configuration with protection rules
    environment: 
      name: development
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    # ðŸŽ¯ Deployment conditions
    if: |
      needs.quality-gate.outputs.deploy-ready == 'true' &&
      (
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && inputs.deploy_to_dev == true)
      )
    
    steps:
      - name: 'ðŸ“¥ Download deployment artifact'
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./publish
      
      # ðŸš€ Use our custom deployment action
      - name: 'ðŸš€ Deploy to Azure Web App (Development)'
        id: deploy
        uses: ./.github/actions/deploy-azure
        with:
          app-name: ${{ vars.AZURE_WEBAPP_NAME_DEV }}
          package-path: './publish'
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # ðŸ”— Comment on PR with deployment info (if PR event)
      - name: 'ðŸ’¬ Comment on PR'
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Deployment Successful!\n\n**Environment:** Development\n**URL:** ${{ steps.deploy.outputs.webapp-url }}\n**Version:** ${{ needs.build-and-test.outputs.version }}\n\nThe application has been deployed and is ready for testing! ðŸŽ‰`
            })

  # ðŸŒ PRODUCTION DEPLOYMENT JOB  
  # Deploys to production environment after successful dev deployment
  deploy-prod:
    name: 'ðŸŒ Deploy to Production'
    runs-on: ubuntu-latest
    needs: [build-and-test, quality-gate, deploy-dev]
    
    # ðŸŒ Production environment with enhanced protection
    environment: 
      name: production
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    # ðŸŽ¯ Strict deployment conditions for production
    if: |
      needs.quality-gate.outputs.deploy-ready == 'true' &&
      needs.deploy-dev.result == 'success' &&
      (
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && inputs.deploy_to_prod == true)
      )
    
    steps:
      - name: 'ðŸ“¥ Download deployment artifact'
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./publish
      
      # ðŸš€ Deploy to production using our composite action
      - name: 'ðŸŒ Deploy to Azure Web App (Production)'
        id: deploy
        uses: ./.github/actions/deploy-azure
        with:
          app-name: ${{ vars.AZURE_WEBAPP_NAME_PROD }}
          package-path: './publish'
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      # ðŸŽ‰ Create GitHub release on successful production deployment
      - name: 'ðŸŽ‰ Create GitHub Release'
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const version = "${{ needs.build-and-test.outputs.version }}";
            const releaseUrl = "${{ steps.deploy.outputs.webapp-url }}";
            
            try {
              await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: `v${version}`,
                name: `TailspinToys v${version}`,
                body: `## ðŸš€ Release v${version}\n\n**Deployed to:** ${releaseUrl}\n**Commit:** ${context.sha}\n\nThis release was automatically created after successful production deployment.`,
                draft: false,
                prerelease: false
              });
              console.log(`âœ… Release v${version} created successfully`);
            } catch (error) {
              console.log(`â„¹ï¸  Release creation skipped: ${error.message}`);
            }

  # ðŸ“Š POST-DEPLOYMENT JOB
  # Runs post-deployment validation and sends notifications  
  post-deployment:
    name: 'ðŸ“Š Post-Deployment Tasks'
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy-dev, deploy-prod]
    if: always() && (needs.deploy-dev.result != 'skipped' || needs.deploy-prod.result != 'skipped')
    
    steps:
      - name: 'ðŸ“Š Generate deployment summary'
        run: |
          echo "## ðŸš€ TailspinToys Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Status | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|--------|-----|" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.deploy-dev.result }}" == "success" ]]; then
            echo "| Development | âœ… Success | [View App](${{ needs.deploy-dev.outputs.webapp-url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-dev.result }}" != "skipped" ]]; then
            echo "| Development | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.deploy-prod.result }}" == "success" ]]; then
            echo "| Production | âœ… Success | [View App](${{ needs.deploy-prod.outputs.webapp-url }}) |" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.deploy-prod.result }}" != "skipped" ]]; then
            echo "| Production | âŒ Failed | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Version:** ${{ needs.build-and-test.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

